name: CI Release & Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write         # éœ€è¦å†™æƒé™æ¨ç‰ˆæœ¬æäº¤/æ ‡ç­¾
  issues: write
  pull-requests: write
  security-events: write

concurrency:
  group: main-ci
  cancel-in-progress: true

jobs:
  shellcheck:
    name: ShellCheck ğŸ› 
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: ğŸš Full ShellCheck
        uses: redhat-plumbers-in-action/differential-shellcheck@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          triggering-event: ${{ github.event_name }}
          strict-check-on-push: true
          base: ${{ github.event.before }}
          head: ${{ github.sha }}
          severity: error

  build-test:
    name: Pre-Build éªŒè¯
    runs-on: ubuntu-latest
    needs: [shellcheck]
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      - name: è¯•æ„å»º
        run: npm run build

  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: [build-test]
    outputs:
      released: ${{ steps.mark.outputs.released }}
      version:  ${{ steps.mark.outputs.version }}
    steps:
      - name: Checkout (å®Œæ•´å†å²)
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      - name: è¿è¡Œ semantic-release
        id: sr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release || echo "NO_RELEASE"
      - name: æ ‡è®°å‘å¸ƒç»“æœ
        id: mark
        run: |
          if git log -1 --pretty=%s | grep -q "^chore(release):"; then
            ver=$(git log -1 --pretty=%s | sed -E 's/^chore\(release\): ([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
            echo "released=true"  >> $GITHUB_OUTPUT
            echo "version=$ver"   >> $GITHUB_OUTPUT
          else
            echo "released=false" >> $GITHUB_OUTPUT
            echo "version="       >> $GITHUB_OUTPUT

  build-and-deploy:
    name: Build & Deploy (å§‹ç»ˆéƒ¨ç½²)
    runs-on: ubuntu-latest
    needs: [release]
    steps:
      - name: Checkout æœ€æ–°ä»£ç /æ ‡ç­¾
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: åŒæ­¥å¯èƒ½çš„ç‰ˆæœ¬æäº¤
        run: |
          git fetch origin main --tags
          git checkout main
          git reset --hard origin/main
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      - name: è¯»å–ç‰ˆæœ¬
        id: ver
        run: echo "pkg_version=$(node -p \"require('./package.json').version\")" >> $GITHUB_OUTPUT
      - name: æ„å»º (æœ€ç»ˆ)
        run: npm run build
      - name: éƒ¨ç½²
        env:
          DEPLOY_REPO_TOKEN: ${{ secrets.DEPLOY_REPO_TOKEN }}
        run: ./scripts/sync-dist.sh dist
      - name: è¾“å‡ºä¿¡æ¯
        run: |
          echo "semantic-releaseè§¦å‘: ${{ needs.release.outputs.released }}"
          echo "ç‰ˆæœ¬å·: ${{ steps.ver.outputs.pkg_version }}"