name: CI Release & Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  security-events: write

concurrency:
  group: main-ci
  cancel-in-progress: true

jobs:
  shellcheck:
    name: ShellCheck ğŸ› 
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: ğŸš Full ShellCheck
        uses: redhat-plumbers-in-action/differential-shellcheck@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          triggering-event: ${{ github.event_name }}
          strict-check-on-push: true
          base: ${{ github.event.before }}
          head: ${{ github.sha }}
          severity: error

  build-test:
    name: Pre-Build éªŒè¯
    runs-on: ubuntu-latest
    needs: [shellcheck]
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      - name: è¯•æ„å»º
        run: npm run build

  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: [build-test]
    outputs:
      released: ${{ steps.mark.outputs.released }}
      version:  ${{ steps.mark.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      - name: è¿è¡Œ semantic-release
        id: sr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          npx semantic-release || echo "NO_RELEASE"
      - name: æ ‡è®°å‘å¸ƒç»“æœ
        id: mark
        run: |
          set -e
          msg="$(git log -1 --pretty=%s)"
          if [[ "$msg" =~ ^chore\(release\):\ ([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            ver="${BASH_REMATCH[1]}"
            echo "released=true"  >> "$GITHUB_OUTPUT"
            echo "version=$ver"   >> "$GITHUB_OUTPUT"
          else
            ver=$(node -p "require('./package.json').version")
            echo "released=false" >> "$GITHUB_OUTPUT"
            echo "version=$ver"   >> "$GITHUB_OUTPUT"
          fi
          echo "æœ€åæäº¤ä¿¡æ¯: $msg"
          echo "è¯†åˆ«ç‰ˆæœ¬: $ver"

  build-and-deploy:
    name: Build & Deploy (always)
    runs-on: ubuntu-latest
    needs: [release]
    if: ${{ !cancelled() }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: åŒæ­¥è¿œç«¯
        run: |
          git fetch origin main --tags
          git checkout main
          git reset --hard origin/main
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      - name: èµ‹äºˆæƒé™
        run: chmod +x scripts/sync-dist.sh || true
      - name: æ„å»º
        env:
          CONTRIBUTOR_INFORMATION_TOKEN: ${{ secrets.CONTRIBUTOR_INFORMATION_TOKEN }}
        run: npm run build
      - name: éƒ¨ç½²
        env:
          DEPLOY_REPO_TOKEN: ${{ secrets.DEPLOY_REPO_TOKEN }}
        run: bash scripts/sync-dist.sh dist
      - name: è¾“å‡ºä¿¡æ¯
        run: |
          echo "æ˜¯å¦äº§ç”Ÿæ–°ç‰ˆæœ¬: ${{ needs.release.outputs.released }}"
          echo "ç‰ˆæœ¬å·: ${{ needs.release.outputs.version }}"